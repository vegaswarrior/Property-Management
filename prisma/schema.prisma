generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
}
model Product {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String      @unique(map: "product_slug_idx")
  category    String
  subCategory String?
  images      String[]
  imageColors String[]   @default([])
  brand       String
  description String
  streetAddress String?
  unitNumber    String?
  stock       Int
  price       Decimal     @default(0) @db.Decimal(12, 2)
  rating      Decimal     @default(0) @db.Decimal(3, 2)
  numReviews  Int         @default(0)
  bedrooms    Int?
  bathrooms   Decimal?    @db.Decimal(3, 1)
  sizeSqFt    Int?
  isFeatured  Boolean     @default(false)
  banner      String?
  printfulProductId String?
  onSale      Boolean     @default(false)
  salePercent Decimal?    @db.Decimal(5, 2)
  saleUntil   DateTime?   @db.Timestamp(6)
  createdAt   DateTime    @default(now()) @db.Timestamp(6)
  OrderItem   OrderItem[]
  Review      Review[]

  variants ProductVariant[]
  productPromos ProductPromo[]
}

model User {
  id                  String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String                           @default("NO_NAME")
  email               String                           @unique(map: "user_email_idx")
  emailVerified       DateTime?                        @db.Timestamp(6)
  image               String?
  password            String?
  role                String                           @default("user")
  shippingAddress     Json?                            @db.Json
  billingAddress      Json?                            @db.Json
  address             Json?                            @db.Json
  paymentMethod       String?
  stripeCustomerId    String?
  phoneNumber         String?
  phoneVerified       DateTime?                        @db.Timestamp(6)
  notificationPreferences Json?                         @db.Json // { email: boolean, sms: boolean, both: boolean }
  isBlocked           Boolean                          @default(false)
  blockedAt           DateTime?                        @db.Timestamp(6)
  blockedBy           String?                          @db.Uuid
  blockedReason       String?
  createdAt           DateTime                         @default(now()) @db.Timestamp(6)
  updatedAt           DateTime                         @updatedAt
  account             Account[]
  session             Session[]
  Cart                Cart[]
  Order               Order[]
  Review              Review[]
  savedPaymentMethods SavedPaymentMethod[]
  paymentMethodTokens PaymentMethodVerificationToken[]
  threadParticipants  ThreadParticipant[]
  friends             Friend[]                        @relation("UserFriends")
  friendOf            Friend[]                        @relation("UserFriendOf")
  blogPosts           BlogPost[]
  blogComments        BlogComment[]
  blogReactions       BlogReaction[]
  leasesAsTenant      Lease[]
  rentPayments        RentPayment[]
  cashPayments        CashPayment[]
  maintenanceTickets  MaintenanceTicket[]
  rentalApplications  RentalApplication[]
  landlordsOwned      Landlord[]
  notifications       Notification[]
  uploadedDocuments   ScannedDocument[]

  applicationDocuments ApplicationDocument[]

  leaseViolations      LeaseViolation[]
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model EmailVerificationToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PasswordResetToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PhoneVerificationToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String   @db.Uuid
  phone    String
  otp      String
  expires  DateTime
  attempts Int      @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([userId])
  @@index([phone])
}

model Cart {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?  @db.Uuid
  sessionCartId String
  items         Json[]   @default([]) @db.Json
  itemsPrice    Decimal  @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2)
  shippingPrice Decimal  @db.Decimal(12, 2)
  taxPrice      Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String      @db.Uuid
  shippingAddress    Json        @db.Json
  paymentMethod      String
  paymentResult      Json?       @db.Json
  itemsPrice         Decimal     @db.Decimal(12, 2)
  shippingPrice      Decimal     @db.Decimal(12, 2)
  taxPrice           Decimal     @db.Decimal(12, 2)
  totalPrice         Decimal     @db.Decimal(12, 2)
  isPaid             Boolean     @default(false)
  paidAt             DateTime?   @db.Timestamp(6)
  isDelivered        Boolean     @default(false)
  deliveredAt        DateTime?   @db.Timestamp(6)
  trackingNumber     String?     @unique
  trackingStatus     String?     @default("pending")
  trackingEvents     Json[]      @default([]) @db.Json
  lastTrackingUpdate DateTime?   @db.Timestamp(6)
  createdAt          DateTime    @default(now()) @db.Timestamp(6)
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderitems         OrderItem[]
}

model OrderItem {
  orderId      String  @db.Uuid
  productId    String  @db.Uuid
  qty          Int
  price        Decimal @db.Decimal(12, 2)
  name         String
  slug         String
  image        String
  variantId    String? @db.Uuid
  variantColor String?
  variantSize  String?
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([orderId, productId], map: "orderitems_orderId_productId_pk")
}

model Color {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  hex       String?
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model Size {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model ProductVariant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @db.Uuid
  sku       String?  @unique
  colorId   String?  @db.Uuid
  sizeId    String?  @db.Uuid
  images    String[] @default([])
  price     Decimal  @db.Decimal(12, 2)
  stock     Int
  printfulExternalId String?
  createdAt DateTime @default(now()) @db.Timestamp(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color   Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)
  size    Size?   @relation(fields: [sizeId], references: [id], onDelete: SetNull)
}

model Review {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @db.Uuid
  productId          String   @db.Uuid
  rating             Int
  title              String
  description        String
  isVerifiedPurchase Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPaymentMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String
  cardholderName        String?
  last4                 String
  expirationDate        String?
  brand                 String?
  billingAddress        Json?    @db.Json
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentMethodId])
}

model PaymentMethodVerificationToken {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @db.Uuid
  paymentMethodId String   @db.Uuid
  token           String   @unique
  expires         DateTime
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Coupon {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])
}

model PromoCode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])

  productPromos ProductPromo[]
}

model ProductPromo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String   @db.Uuid
  promoCodeId String   @db.Uuid

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([productId, promoCodeId])
}

model ShippingSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  baseShippingCost Decimal @db.Decimal(10, 2)
  freeShippingThreshold Decimal @db.Decimal(12, 2)
  uspsIntegrationEnabled Boolean @default(false)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}

model TaxSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taxRate         Decimal  @db.Decimal(5, 2)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}

// Cash payment tracking for retail location payments
model CashPayment {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  referenceId       String   @unique
  paymentIntentId   String   @db.Uuid
  tenantId          String   @db.Uuid
  propertyId        String   @db.Uuid
  amount            Decimal  @db.Decimal(10, 2)
  fee               Decimal  @db.Decimal(10, 2)
  status            String   @default("pending") // pending, completed, expired, failed
  partnerId         String   // paynearme, greendot, moneygram
  barcodeData       String   // JSON data for barcode
  confirmationNumber String? // Retail location confirmation
  expiresAt         DateTime
  processedAt       DateTime?
  createdAt         DateTime @default(now()) @db.Timestamp(6)
  updatedAt         DateTime @updatedAt @db.Timestamp(6)

  tenant    User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([referenceId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
  @@index([expiresAt])
}

model Thread {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type            String   @default("contact") // contact, support, dm
  subject         String?
  fromEmail       String?
  toEmail         String?
  createdByUserId String?  @db.Uuid
  status          String   @default("open") // open, closed, pending
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  messages           Message[]
  participants ThreadParticipant[]
}

model Message {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId      String   @db.Uuid
  senderUserId  String?  @db.Uuid
  senderName    String?
  senderEmail   String?
  content       String
  role          String   @default("user") // user, admin, system, ai
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model ThreadParticipant {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId   String   @db.Uuid
  userId     String   @db.Uuid
  lastReadAt DateTime?

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model Friend {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  friendId  String   @db.Uuid
  status    String   @default("pending") // pending, accepted, declined, blocked
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user   User @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("UserFriendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model BlogPost {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  slug        String   @unique
  excerpt     String?
  contentHtml String
  coverImage  String?
  mediaUrls   String[] @default([])
  tags        String[] @default([])
  isPublished Boolean  @default(true)
  authorId    String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  comments  BlogComment[]
  reactions BlogReaction[]
}

model BlogComment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  content   String
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model BlogReaction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  type      String   @default("like") // like/heart, future types
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId])
}

model AnalyticsEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  path          String
  referrer      String?
  country       String?
  region        String?
  city          String?
  userAgent     String?
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  @@index([sessionCartId])
  @@index([userId])
  @@index([path])
  @@index([createdAt])
}

model SupportStatus {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  isOnline  Boolean  @default(true)
  updatedBy String?  @db.Uuid
  updatedAt DateTime @default(now()) @db.Timestamp(6)
}

model Landlord {
  id                     String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  subdomain              String     @unique
  ownerUserId            String?    @db.Uuid
  stripeConnectAccountId String?
  stripeOnboardingStatus String?
  createdAt              DateTime   @default(now()) @db.Timestamp(6)
  updatedAt              DateTime   @updatedAt

  inviteViaEmail         Boolean    @default(true)
  inviteViaSms           Boolean    @default(false)

  // Branding
  logoUrl                String?
  customDomain           String?    @unique
  companyName            String?
  companyEmail           String?
  companyPhone           String?
  companyAddress         String?
  themeColor             String     @default("violet") // violet, emerald, blue, rose, amber
  heroImages             String[]   @default([]) // up to 3 hero images for portal
  aboutBio               String?
  aboutPhoto             String?
  aboutGallery           String[]   @default([])

  // Onboarding / intake fields
  unitsEstimateMin       Int?
  unitsEstimateMax       Int?
  ownsProperties         Boolean?   @default(false)
  managesForOthers       Boolean?   @default(false)
  useSubdomain           Boolean    @default(true)

  // Subscription & Tier
  subscriptionTier       String     @default("free") // free, growth, professional, enterprise
  stripeSubscriptionId   String?
  stripeCustomerId       String?
  subscriptionStatus     String     @default("active") // active, past_due, canceled, trialing
  subscriptionEndsAt     DateTime?  @db.Timestamp(6)
  unitLimitNotifiedAt    DateTime?  @db.Timestamp(6) // last time we sent unit limit warning
  freeBackgroundChecks   Boolean    @default(false)
  freeEmploymentVerification Boolean @default(false)

  owner      User?      @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)
  properties Property[]
  payouts    Payout[]
  platformFees PlatformFee[]
  savedPayoutMethods SavedPayoutMethod[]
  legalDocuments LegalDocument[]
  quickBooksConnection QuickBooksConnection?
  docuSignConnection DocuSignConnection?
  scannedDocuments ScannedDocument[]
  classificationRules DocumentClassificationRule[]
  subscription LandlordSubscription?

  expenses Expense[]
  marketBenchmarks MarketBenchmark[]

  leaseViolations LeaseViolation[]

  applicationDocuments ApplicationDocument[]
}

model QuickBooksConnection {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @unique @db.Uuid
  realmId               String?
  accessTokenEncrypted  String?
  refreshTokenEncrypted String?
  accessTokenExpiresAt  DateTime?
  oauthState            String?
  connectedAt           DateTime?
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([realmId])
}

model DocuSignConnection {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId           String   @unique @db.Uuid
  accessTokenEncrypted String?
  refreshTokenEncrypted String?
  accessTokenExpiresAt DateTime?
  oauthState           String?
  connectedAt          DateTime?
  createdAt            DateTime @default(now()) @db.Timestamp(6)
  updatedAt            DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
}

model SavedPayoutMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String   // 'bank_account' or 'card' (for instant payouts)
  accountHolderName     String?
  last4                 String
  bankName              String?
  accountType           String?  // 'checking' or 'savings'
  routingNumber         String?
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  landlord              Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([stripePaymentMethodId])
}

model Property {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  address     Json     @db.Json
  type        String   // e.g. apartment, house, office, mixed-use
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  landlordId String?   @db.Uuid

  landlord Landlord? @relation(fields: [landlordId], references: [id], onDelete: SetNull)

  units       Unit[]
  cashPayments CashPayment[]
  inspections PropertyInspection[]
  schedule    PropertySchedule?
  appointments PropertyAppointment[]

  finance PropertyFinance?
  expenses Expense[]
  marketBenchmarks MarketBenchmark[]
}

model Unit {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId   String   @db.Uuid
  name         String   // e.g. 101, 2B, Suite 300
  type         String   // room, apartment, office, house
  bedrooms     Int?
  bathrooms    Decimal? @db.Decimal(3, 1)
  sizeSqFt     Int?
  rentAmount   Decimal  @db.Decimal(12, 2)
  isAvailable  Boolean  @default(true)
  availableFrom DateTime?
  images       String[] @default([])
  amenities    String[] @default([])
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  leases       Lease[]
  tickets      MaintenanceTicket[]
  applications RentalApplication[]

  expenses Expense[]

  leaseViolations LeaseViolation[]
}

model Lease {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId         String   @db.Uuid
  tenantId       String   @db.Uuid
  startDate      DateTime @db.Timestamp(6)
  endDate        DateTime? @db.Timestamp(6)
  rentAmount     Decimal  @db.Decimal(12, 2)
  billingDayOfMonth Int   // 1-28 typically
  status         String   @default("active") // active, ended, pending
  docusignEnvelopeId String?
  tenantSignedAt DateTime? @db.Timestamp(6)
  landlordSignedAt DateTime? @db.Timestamp(6)
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @updatedAt

  unit   Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  rentPayments RentPayment[]
  signatureRequests DocumentSignatureRequest[]

  violations LeaseViolation[]
}

model RentPayment {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leaseId       String   @db.Uuid
  tenantId      String   @db.Uuid
  dueDate       DateTime @db.Timestamp(6)
  paidAt        DateTime? @db.Timestamp(6)
  amount        Decimal  @db.Decimal(12, 2)
  status        String   @default("pending") // pending, processing, paid, failed, overdue
  stripePaymentIntentId String?
  stripeInvoiceId       String?
  paymentMethod String?  // card, us_bank_account, apple_pay, google_pay, link
  convenienceFee Decimal? @default(0) @db.Decimal(12, 2)
  isRecurring   Boolean  @default(false)
  metadata      Json?    @db.Json
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  payoutId String? @db.Uuid

  lease  Lease @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenant User  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  payout Payout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)
}

model Payout {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId     String   @db.Uuid
  amount         Decimal  @db.Decimal(12, 2)
  status         String   @default("pending") // pending, processing, paid, failed
  initiatedAt    DateTime @default(now()) @db.Timestamp(6)
  paidAt         DateTime? @db.Timestamp(6)
  stripeTransferId String?
  metadata       Json?    @db.Json

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  rentPayments RentPayment[]
  platformFees PlatformFee[]

  @@index([landlordId])
}

model PlatformFee {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payoutId    String   @db.Uuid
  landlordId  String   @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  type        String   @default("instant_payout_fee") // e.g. instant_payout_fee
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  metadata    Json?    @db.Json

  payout   Payout   @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([payoutId])
}

model MaintenanceTicket {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId      String?  @db.Uuid
  tenantId    String?  @db.Uuid
  title       String
  description String
  status      String   @default("open") // open, in_progress, resolved, closed
  priority    String   @default("medium") // low, medium, high, urgent
  assignedToName String?
  cost        Decimal? @db.Decimal(12, 2)
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt
  resolvedAt  DateTime? @db.Timestamp(6)

  unit   Unit? @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant User? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Expense {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId  String   @db.Uuid
  propertyId  String?  @db.Uuid
  unitId      String?  @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  category    String
  description String?
  incurredAt  DateTime @db.Timestamp(6)
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     Unit?     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([propertyId])
  @@index([unitId])
  @@index([incurredAt])
  @@index([category])
}

model MarketBenchmark {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId     String   @db.Uuid
  propertyId     String?  @db.Uuid
  zip            String?
  propertyType   String?
  bedrooms       Int?
  averageRent    Decimal  @db.Decimal(12, 2)
  source         String?  // manual, zillow, rentometer, etc.
  effectiveDate  DateTime @db.Timestamp(6)
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([propertyId])
  @@index([effectiveDate])
}

model PropertyFinance {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId            String   @unique @db.Uuid
  purchasePrice         Decimal? @db.Decimal(12, 2)
  downPayment           Decimal? @db.Decimal(12, 2)
  loanBalance           Decimal? @db.Decimal(12, 2)
  interestRatePercent   Decimal? @db.Decimal(6, 3)
  loanTermMonths        Int?
  annualPropertyTax     Decimal? @db.Decimal(12, 2)
  annualInsurance       Decimal? @db.Decimal(12, 2)
  hoaMonthly            Decimal? @db.Decimal(12, 2)
  managementFeePercent  Decimal? @db.Decimal(6, 3)
  appreciationRatePercent Decimal? @db.Decimal(6, 3)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model LeaseViolation {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId  String   @db.Uuid
  leaseId     String   @db.Uuid
  tenantId    String?  @db.Uuid
  unitId      String?  @db.Uuid
  type        String
  description String?
  occurredAt  DateTime @db.Timestamp(6)
  resolvedAt  DateTime? @db.Timestamp(6)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  landlord Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  lease    Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  tenant   User?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  unit     Unit?    @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([leaseId])
  @@index([tenantId])
  @@index([unitId])
  @@index([occurredAt])
  @@index([type])
}

model RentalApplication {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unitId       String?  @db.Uuid
  applicantId  String?  @db.Uuid
  fullName     String
  email        String
  phone        String?
  moveInDate   DateTime? @db.Timestamp(6)
  monthlyIncome Decimal? @db.Decimal(12, 2)
  employmentStatus String?
  notes        String?
  adminResponse String?
  propertySlug  String?
  encryptedSsn  String?  // Encrypted SSN - never store in plain text
  status       String   @default("pending") // pending, approved, rejected, withdrawn
  screeningProvider String?
  screeningBundle   String? // e.g. eviction_only, background_only, full_package
  screeningStatus   String? // requested, in_progress, complete, failed
  screeningReportUrl String?
  screeningRequestedAt DateTime? @db.Timestamp(6)
  screeningCompletedAt DateTime? @db.Timestamp(6)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt

  unit      Unit? @relation(fields: [unitId], references: [id], onDelete: Cascade)
  applicant User? @relation(fields: [applicantId], references: [id], onDelete: SetNull)

  documents ApplicationDocument[]
}

model ApplicationDocument {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @db.Uuid
  landlordId    String   @db.Uuid
  uploadedById  String   @db.Uuid

  category      String
  docType       String

  originalFileName String
  mimeType      String
  fileSize      Int

  cloudinaryPublicId   String
  cloudinaryResourceType String @default("raw")
  status        String   @default("uploaded")

  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  application   RentalApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  landlord      Landlord          @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  uploadedBy    User              @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([landlordId])
  @@index([uploadedById])
  @@index([category])
  @@index([docType])
  @@index([status])
}

model Notification {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @db.Uuid
  type        String   // application, message, maintenance, payment, reminder
  title       String
  message     String
  isRead      Boolean  @default(false)
  actionUrl   String?  // URL to redirect when clicked
  metadata    Json?    // Additional data like applicationId, ticketId, etc.
  createdAt   DateTime @default(now()) @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model LegalDocument {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId      String   @db.Uuid
  name            String
  type            String   // 'lease', 'addendum', 'disclosure', 'notice', 'other'
  category        String?  // 'custom', 'state_template'
  state           String?  // State code for state-specific templates (e.g., 'NV', 'CA')
  fileUrl         String?  // URL to uploaded file (S3/Cloudinary)
  fileType        String?  // 'pdf', 'docx', 'doc'
  fileSize        Int?     // Size in bytes
  isTemplate      Boolean  @default(false) // If true, this is a template that can be used for new leases
  isActive        Boolean  @default(true)
  description     String?
  docusignTemplateId String? // DocuSign template ID if integrated
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  landlord        Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  signatureRequests DocumentSignatureRequest[]

  @@index([landlordId])
  @@index([type])
}

model DocumentSignatureRequest {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId        String   @db.Uuid
  leaseId           String?  @db.Uuid
  recipientEmail    String
  recipientName     String
  status            String   @default("pending") // 'pending', 'sent', 'viewed', 'signed', 'declined', 'expired'
  docusignEnvelopeId String? // DocuSign envelope ID
  signedAt          DateTime?
  expiresAt         DateTime?
  token             String?   @unique
  signerName        String?
  signerEmail       String?
  signerIp          String?
  signerUserAgent   String?
  signedPdfUrl      String?
  auditLogUrl       String?
  documentHash      String?
  role              String   @default("tenant") // tenant, landlord
  createdAt         DateTime @default(now()) @db.Timestamp(6)
  updatedAt         DateTime @updatedAt

  document          LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  lease             Lease?        @relation(fields: [leaseId], references: [id], onDelete: SetNull)

  @@index([documentId])
  @@index([leaseId])
  @@index([status])
  @@index([token])
  @@index([role])
}

model PropertyInspection {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId  String   @db.Uuid
  inspectorId String?  @db.Uuid
  unitId      String?  @db.Uuid
  status      String   @default("in_progress") // in_progress, completed, cancelled
  location    Json?    @db.Json // { lat, lng }
  summary     Json?    @db.Json // { total, passed, failed, warnings }
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  completedAt DateTime? @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    InspectionItem[]

  @@index([propertyId])
  @@index([status])
}

model InspectionItem {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inspectionId String   @db.Uuid
  category     String   // exterior, interior, kitchen, bathroom, safety
  item         String
  status       String   // pass, fail, warning
  notes        String?
  photos       String[] @default([])
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  inspection PropertyInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
}

model PropertySchedule {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId String   @db.Uuid
  schedule   Json     @db.Json // { monday: { enabled: true, slots: [{start: "09:00", end: "17:00"}] }, ... }
  timezone   String   @default("America/Los_Angeles")
  slotDuration Int    @default(30) // minutes
  bufferTime   Int    @default(0) // minutes between appointments
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId])
  @@index([propertyId])
}

model PropertyAppointment {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  propertyId  String   @db.Uuid
  scheduleId  String?  @db.Uuid
  name        String
  email       String
  phone       String?
  date        DateTime @db.Timestamp(6)
  startTime   String   // "09:00"
  endTime     String   // "09:30"
  status      String   @default("pending") // pending, confirmed, cancelled, completed
  notes       String?
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([date])
  @@index([status])
}

model ScannedDocument {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId      String   @db.Uuid
  uploadedBy      String?  @db.Uuid
  originalFileName String
  fileUrl         String   // S3/Cloudinary URL
  fileType        String   // pdf, jpg, png, etc
  fileSize        Int      // bytes
  ocrText         String?  // Extracted text from OCR
  ocrConfidence   Decimal? @db.Decimal(5, 2) // 0-100 confidence score
  ocrProcessedAt  DateTime? @db.Timestamp(6)
  
  // Classification
  documentType    String?  // lease, receipt, application, notice, other
  classificationStatus String @default("pending") // pending, classified, manual_review
  classifiedAt    DateTime? @db.Timestamp(6)
  
  // Extracted metadata (AI/manual)
  extractedData   Json?    @db.Json // Flexible field for extracted info
  
  // Conversion status
  conversionStatus String  @default("pending") // pending, in_progress, completed, failed, skipped
  convertedToLeaseId String? @db.Uuid
  convertedToPaymentId String? @db.Uuid
  convertedToTenantId String? @db.Uuid
  
  notes           String?
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  landlord        Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)
  uploader        User?    @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([documentType])
  @@index([classificationStatus])
  @@index([conversionStatus])
  @@index([createdAt])
}

model DocumentClassificationRule {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId      String?  @db.Uuid // null = global rule
  documentType    String   // lease, receipt, application, etc
  keywords        String[] @default([]) // Keywords to match
  patterns        String[] @default([]) // Regex patterns
  priority        Int      @default(0) // Higher priority rules checked first
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  landlord        Landlord? @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([documentType])
}

model LandlordSubscription {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @unique @db.Uuid
  tier                  String   @default("free") // free, growth, professional, enterprise
  stripeSubscriptionId  String?  @unique
  stripeCustomerId      String?
  stripePriceId         String?
  status                String   @default("active") // active, past_due, canceled, trialing, incomplete
  currentPeriodStart    DateTime? @db.Timestamp(6)
  currentPeriodEnd      DateTime? @db.Timestamp(6)
  cancelAtPeriodEnd     Boolean  @default(false)
  canceledAt            DateTime? @db.Timestamp(6)
  trialEnd              DateTime? @db.Timestamp(6)
  
  // Tier limits
  unitLimit             Int      @default(24) // Free tier: 24 units
  
  // Perks
  freeBackgroundChecks  Boolean  @default(false)
  freeEvictionChecks    Boolean  @default(false)
  freeEmploymentVerification Boolean @default(false)
  
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  landlord              Landlord @relation(fields: [landlordId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([tier])
}

model SubscriptionEvent {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @db.Uuid
  eventType             String   // upgrade, downgrade, canceled, payment_failed, renewed
  fromTier              String?
  toTier                String?
  amount                Decimal? @db.Decimal(12, 2)
  stripeEventId         String?  @unique
  metadata              Json?    @db.Json
  createdAt             DateTime @default(now()) @db.Timestamp(6)

  @@index([landlordId])
  @@index([eventType])
  @@index([createdAt])
}

// Employment verification tracking for subscription limits
model EmploymentCheck {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  applicationId String   @db.Uuid
  status        String   @default("pending") // pending, completed, failed
  result        Json?    @db.Json
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  @@index([landlordId])
  @@index([applicationId])
  @@index([createdAt])
}

// Team management for Professional tier
model TeamMember {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  userId        String   @db.Uuid
  role          String   @default("member") // owner, admin, member
  permissions   String[] @default([]) // view_properties, manage_tenants, manage_maintenance, manage_finances
  invitedEmail  String?
  inviteToken   String?  @unique
  inviteExpires DateTime? @db.Timestamp(6)
  status        String   @default("pending") // pending, active, inactive
  joinedAt      DateTime? @db.Timestamp(6)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  @@unique([landlordId, userId])
  @@index([landlordId])
  @@index([userId])
  @@index([inviteToken])
}

// Team communication channels (Slack-like)
model TeamChannel {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId    String   @db.Uuid
  name          String
  description   String?
  type          String   @default("public") // public, private, direct
  createdById   String   @db.Uuid
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  messages      TeamMessage[]
  members       TeamChannelMember[]

  @@index([landlordId])
}

model TeamChannelMember {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId     String   @db.Uuid
  userId        String   @db.Uuid
  role          String   @default("member") // admin, member
  lastReadAt    DateTime? @db.Timestamp(6)
  joinedAt      DateTime @default(now()) @db.Timestamp(6)

  channel       TeamChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
}

model TeamMessage {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  channelId     String   @db.Uuid
  senderId      String   @db.Uuid
  content       String
  attachments   String[] @default([])
  isEdited      Boolean  @default(false)
  editedAt      DateTime? @db.Timestamp(6)
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  channel       TeamChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([senderId])
  @@index([createdAt])
}

// Automatic rent reminder settings
model RentReminderSettings {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @unique @db.Uuid
  enabled               Boolean  @default(false)
  reminderDaysBefore    Int[]    @default([7, 3, 1]) // Days before due date to send reminders
  reminderChannels      String[] @default(["email"]) // email, sms, push
  customMessage         String?
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  @@index([landlordId])
}

// Automatic late fee settings
model LateFeeSettings {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  landlordId            String   @unique @db.Uuid
  enabled               Boolean  @default(false)
  gracePeriodDays       Int      @default(5) // Days after due date before late fee applies
  feeType               String   @default("flat") // flat, percentage
  feeAmount             Decimal  @db.Decimal(12, 2) // Flat amount or percentage
  maxFee                Decimal? @db.Decimal(12, 2) // Maximum late fee cap
  recurringFee          Boolean  @default(false) // Apply fee daily/weekly after grace period
  recurringInterval     String?  // daily, weekly
  notifyTenant          Boolean  @default(true)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt

  @@index([landlordId])
}

// Blocked IP addresses for security
model BlockedIP {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ipAddress     String   @unique
  reason        String?
  blockedBy     String?  @db.Uuid
  expiresAt     DateTime? @db.Timestamp(6) // null = permanent
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  updatedAt     DateTime @updatedAt

  @@index([ipAddress])
  @@index([expiresAt])
}
